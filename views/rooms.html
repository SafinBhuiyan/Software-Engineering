<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Available Rooms - Unislot</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="navbar-logo">
                <img src="/images/logo.png" alt="Unislot Logo">
            </div>
            <div class="navbar-nav">
                <a href="/dashboard_teacher" class="nav-link">Dashboard</a>
                <a href="/rooms" class="nav-link active">Rooms</a>
                <a href="/teacher_bookings" class="nav-link">All Bookings</a>
            </div>
            <div class="navbar-auth">
                <button id="logoutBtn" class="btn-nav btn-logout">Logout</button>
            </div>
        </nav>

        <main class="main-content">
            <div class="dashboard-section">
                <h2>Available Rooms</h2>
                <div class="action-buttons">
                    <div class="button-group">
                        <h3>Room Management</h3>
                        <p>Create and manage presentation rooms</p>
                        <button class="btn btn-primary" onclick="showCreateRoomModal()">Create New Room</button>
                    </div>
                </div>
            </div>

            <div class="dashboard-section">
                <h2>Rooms</h2>
                <div id="roomsContainer" class="rooms-grid">
                    <p>Loading available rooms...</p>
                </div>
            </div>
        </main>

        <!-- Create Room Modal -->
        <div id="createRoomModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Create New Room</h3>
                    <span class="modal-close" onclick="hideCreateRoomModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="createRoomForm">
                        <div class="form-group">
                            <label for="room_no">Room Number:</label>
                            <input type="text" id="room_no" name="room_no" required placeholder="e.g., 101, 56, LAB-1">
                        </div>
                        <!-- Only using fields that exist in the schema -->
                        <div class="form-group">
                            <label for="date">Date:</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="time_from">Start Time:</label>
                                <input type="time" id="time_from" name="time_from" required>
                            </div>
                            <div class="form-group">
                                <label for="time_to">End Time:</label>
                                <input type="time" id="time_to" name="time_to" required>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="hideCreateRoomModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Create Room</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Edit Room Modal -->
        <div id="editRoomModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Edit Room</h3>
                    <span class="modal-close" onclick="hideEditRoomModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="editRoomForm">
                        <input type="hidden" id="edit_room_id" name="room_id">
                        <div class="form-group">
                            <label for="edit_room_no">Room Number:</label>
                            <input type="text" id="edit_room_no" name="room_no" required placeholder="e.g., 101, 56, LAB-1">
                        </div>
                        <div class="form-group">
                            <label for="edit_date">Date:</label>
                            <input type="date" id="edit_date" name="date" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit_time_from">Start Time:</label>
                                <input type="time" id="edit_time_from" name="time_from" required>
                            </div>
                            <div class="form-group">
                                <label for="edit_time_to">End Time:</label>
                                <input type="time" id="edit_time_to" name="time_to" required>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="hideEditRoomModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Update Room</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p>&copy; 2025 Unislot-Presentation Room Booking System</p>
        </footer>
    </div>

    <script>
        // Check authentication on page load
        window.addEventListener('load', async function() {
            try {
                const response = await fetch('/api/auth/check');
                if (!response.ok) {
                    window.location.href = '/login';
                    return;
                }

                const result = await response.json();
                if (result.role !== 'teacher') {
                    window.location.href = '/login';
                    return;
                }

                // Load rooms
                loadRooms();
            } catch (error) {
                window.location.href = '/login';
            }
        });

        // Load rooms
        async function loadRooms() {
            try {
                const response = await fetch('/api/teacher/rooms');
                const result = await response.json();

                const container = document.getElementById('roomsContainer');

                if (result.rooms.length === 0) {
                    container.innerHTML = '<div class="no-rooms-card"><p class="no-data">No rooms created yet. Create your first room to get started.</p></div>';
                    return;
                }

                const roomsHTML = result.rooms.map(room => {
                    // Format date properly for display and input
                    let formattedDate = 'N/A';
                    let inputDateValue = '';

                    if (room.date_available) {
                        // Handle different date formats from backend
                        let dateStr = '';
                        if (typeof room.date_available === 'string') {
                            // If it's already a string like "2025-01-31"
                            if (room.date_available.includes('-')) {
                                dateStr = room.date_available.split('T')[0]; // Remove time part if present
                            }
                        } else if (room.date_available instanceof Date) {
                            dateStr = room.date_available.toISOString().split('T')[0];
                        }

                        if (dateStr) {
                            // Format for display: DD-MM-YYYY
                            const dateParts = dateStr.split('-');
                            if (dateParts.length === 3) {
                                formattedDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0]}`;
                                inputDateValue = dateStr; // YYYY-MM-DD format for HTML date input
                            }
                        }
                    }

                    // Format time values to HH-MM AM/PM
                    const formatTimeToDisplay = (timeStr) => {
                        if (!timeStr) return '';

                        const [hours, minutes] = timeStr.split(':');
                        const hour24 = parseInt(hours);
                        const hour12 = hour24 === 0 ? 12 : hour24 > 12 ? hour24 - 12 : hour24;
                        const ampm = hour24 >= 12 ? 'PM' : 'AM';

                        return `${String(hour12).padStart(2, '0')}-${String(minutes).padStart(2, '0')} ${ampm}`;
                    };

                    const timeFrom = formatTimeToDisplay(room.time_from);
                    const timeTo = formatTimeToDisplay(room.time_to);

                    return `
                    <div class="room-card">
                        <div class="room-header">
                            <h3>Room ${room.room_no}</h3>
                            <span class="room-status">Active</span>
                        </div>
                        <div class="room-info">
                            <p><strong>Date:</strong> ${formattedDate}</p>
                            <p><strong>Time:</strong> ${timeFrom} - ${timeTo}</p>
                            <p><strong>Available Slots:</strong> ${room.available_slots || 0}/${room.total_slots || 0}</p>
                        </div>
                        <div class="room-actions" style="display: flex; flex-direction: column; gap: 8px;">
                            <button class="btn btn-secondary" onclick="editRoom(${room.room_id}, '${room.room_no}', '${inputDateValue}', '${timeFrom}', '${timeTo}')" style="width: 100%; padding: 12px; font-size: 1rem; font-weight: 600;">
                                Edit Room
                            </button>
                            <button class="btn btn-danger" onclick="deleteRoom(${room.room_id})" style="width: 100%; padding: 12px; font-size: 1rem; font-weight: 600;">
                                Delete Room
                            </button>
                        </div>
                    </div>
                    `;
                }).join('');

                container.innerHTML = roomsHTML;
            } catch (error) {
                document.getElementById('roomsContainer').innerHTML =
                    '<div class="error-card"><p class="error">Error loading rooms. Please refresh the page.</p></div>';
            }
        }

        // Show create room modal
        function showCreateRoomModal() {
            document.getElementById('createRoomModal').style.display = 'block';
        }

        // Hide create room modal
        function hideCreateRoomModal() {
            document.getElementById('createRoomModal').style.display = 'none';
            document.getElementById('createRoomForm').reset();
        }

        // Show edit room modal
        function showEditRoomModal() {
            document.getElementById('editRoomModal').style.display = 'block';
        }

        // Hide edit room modal
        function hideEditRoomModal() {
            document.getElementById('editRoomModal').style.display = 'none';
            document.getElementById('editRoomForm').reset();
        }

        // Edit room
        function editRoom(roomId, roomNo, date, timeFrom, timeTo) {
            document.getElementById('edit_room_id').value = roomId;
            document.getElementById('edit_room_no').value = roomNo;
            document.getElementById('edit_date').value = date;
            document.getElementById('edit_time_from').value = timeFrom;
            document.getElementById('edit_time_to').value = timeTo;
            showEditRoomModal();
        }

        // Handle create room form submission
        document.getElementById('createRoomForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const roomData = Object.fromEntries(formData);

            try {
                const response = await fetch('/api/teacher/create-room', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(roomData)
                });

                const result = await response.json();

                if (result.success) {
                    alert('Room created successfully!');
                    hideCreateRoomModal();
                    loadRooms(); // Refresh the rooms list
                } else {
                    alert(result.error || 'Failed to create room');
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        });

        // Handle edit room form submission
        document.getElementById('editRoomForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const roomData = Object.fromEntries(formData);
            const roomId = roomData.room_id;

            // Remove room_id from the data object as it's in the URL
            delete roomData.room_id;

            try {
                const response = await fetch(`/api/teacher/rooms/${roomId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(roomData)
                });

                const result = await response.json();

                if (result.success) {
                    alert('Room updated successfully!');
                    hideEditRoomModal();
                    loadRooms(); // Refresh the rooms list
                } else {
                    alert(result.error || 'Failed to update room');
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        });


        // Delete room
        async function deleteRoom(roomId) {
            if (!confirm('Are you sure you want to delete this room? This will also delete all associated slots and bookings.')) {
                return;
            }

            try {
                const response = await fetch('/api/teacher/delete-room', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ room_id: roomId })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Room deleted successfully!');
                    loadRooms(); // Refresh the rooms list
                } else {
                    alert(result.error || 'Failed to delete room');
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                window.location.href = '/login';
            }
        });

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const createModal = document.getElementById('createRoomModal');
            const editModal = document.getElementById('editRoomModal');
            if (event.target === createModal) {
                hideCreateRoomModal();
            }
            if (event.target === editModal) {
                hideEditRoomModal();
            }
        });
    </script>
</body>
</html>