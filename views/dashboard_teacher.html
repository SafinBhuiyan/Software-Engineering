<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - Room Booking System</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* Enhanced Modal Styles - Consistent with main UI */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .modal.show {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            /* Inherits all styling from .card base class */
            width: 90%;
            max-width: 500px;
            animation: modalSlideIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            border: 1px solid #B86E9F;
            border-radius: 28px;
            transform: scale(1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: relative;
        }

        .modal-header h3 {
            margin: 0;
            color: #ffffff;
            font-size: 1.4rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .modal-close {
            color: #cccccc;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
        }

        .modal-close:hover {
            color: #ffffff;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(90deg);
        }

        .modal-body {
            margin-bottom: 24px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding-top: 16px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #e0e0e0;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px;
            border: 1px solid #B86E9F;
            border-radius: 0.75rem;
            background: rgba(15, 9, 12, 0.8);
            color: #ffffff;
            font-size: 1rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            appearance: none;
            cursor: pointer;
        }

        .form-group select option {
            background: #1a1a1a;
            color: #ffffff;
            padding: 8px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #B86E9F;
            background: rgba(15, 9, 12, 0.9);
            box-shadow: 0 0 0 3px rgba(184, 110, 159, 0.1);
        }

        /* Calendar icon for date inputs in modal */
        .form-group input[type="date"] {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg' stroke='%23ffffff'%3e%3cg id='SVGRepo_bgCarrier' stroke-width='0'%3e%3c/g%3e%3cg id='SVGRepo_tracerCarrier' stroke-linecap='round' stroke-linejoin='round'%3e%3c/g%3e%3cg id='SVGRepo_iconCarrier'%3e %3cpath d='M3 9H21M7 3V5M17 3V5M6 12H8M11 12H13M16 12H18M6 15H8M11 15H13M16 15H18M6 18H8M11 18H13M16 18H18M6.2 21H17.8C18.9201 21 19.4802 21 19.908 20.782C20.2843 20.5903 20.5903 20.2843 20.782 19.908C21 19.4802 21 18.9201 21 17.8V8.2C21 7.07989 21 6.51984 20.782 6.09202C20.5903 5.71569 20.2843 5.40973 19.908 5.21799C19.4802 5 18.9201 5 17.8 5H6.2C5.0799 5 4.51984 5 4.09202 5.21799C3.71569 5.40973 3.40973 5.71569 3.21799 6.09202C3 6.51984 3 7.07989 3 8.2V17.8C3 18.9201 3 19.4802 3.21799 19.908C3.40973 20.2843 3.71569 20.5903 4.09202 20.782C4.51984 21 5.07989 21 6.2 21Z' stroke='%23ffffff' stroke-width='2' stroke-linecap='round'/%3e %3c/g%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 18px;
            padding-right: 40px;
        }

        /* Clock icon for time inputs in modal */
        .form-group input[type="time"] {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cg id='SVGRepo_bgCarrier' stroke-width='0'%3e%3c/g%3e%3cg id='SVGRepo_tracerCarrier' stroke-linecap='round' stroke-linejoin='round'%3e%3c/g%3e%3cg id='SVGRepo_iconCarrier'%3e %3cpath d='M12 7V12L14.5 10.5M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3e %3c/g%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 18px;
            padding-right: 40px;
        }

        /* Ensure picker indicators are visible and clickable in modal */
        .form-group input[type="date"]::-webkit-calendar-picker-indicator,
        .form-group input[type="time"]::-webkit-calendar-picker-indicator {
            opacity: 1;
            cursor: pointer;
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            color: rgba(255, 255, 255, 0.8);
            z-index: 1;
        }

        /* Modal visibility is now controlled by the 'show' class */

        /* Toast notification styles */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            min-width: 300px;
            max-width: 500px;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.3),
                0 2px 8px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 10000;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toast-icon {
            font-size: 18px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }

        .toast-text {
            flex: 1;
            color: #ffffff;
            font-size: 14px;
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .toast-close:hover {
            color: #ffffff;
            background: rgba(255, 255, 255, 0.1);
        }

        /* Toast types */
        .toast-success {
            background: linear-gradient(135deg,
                rgba(40, 167, 69, 0.9) 0%,
                rgba(32, 201, 151, 0.9) 100%);
            border-color: rgba(40, 167, 69, 0.3);
        }

        .toast-error {
            background: linear-gradient(135deg,
                rgba(220, 53, 69, 0.9) 0%,
                rgba(176, 42, 55, 0.9) 100%);
            border-color: rgba(220, 53, 69, 0.3);
        }

        .toast-warning {
            background: linear-gradient(135deg,
                rgba(255, 193, 7, 0.9) 0%,
                rgba(255, 235, 59, 0.9) 100%);
            border-color: rgba(255, 193, 7, 0.3);
        }

        .toast-warning .toast-icon {
            color: #000;
        }

        .toast-warning .toast-text {
            color: #000;
        }

        .toast-warning .toast-close {
            color: rgba(0, 0, 0, 0.7);
        }

        .toast-warning .toast-close:hover {
            color: #000;
            background: rgba(0, 0, 0, 0.1);
        }

        .toast-info {
            background: linear-gradient(135deg,
                rgba(23, 162, 184, 0.9) 0%,
                rgba(0, 123, 255, 0.9) 100%);
            border-color: rgba(23, 162, 184, 0.3);
        }

        /* Responsive modal design */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 10% auto;
                max-width: none;
            }

            .modal-header h3 {
                font-size: 1.2rem;
            }

            .modal-actions {
                flex-direction: column;
                gap: 8px;
            }

            .modal-actions button {
                width: 100%;
            }

            .toast {
                left: 10px;
                right: 10px;
                min-width: auto;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="navbar-logo">
                <a href="/dashboard_teacher">
                    <img src="/images/logo.png" alt="Unislot Logo">
                </a>
            </div>
            <div class="navbar-nav">
                <a href="/dashboard_teacher" class="nav-link active">Dashboard</a>
                <a href="/rooms" class="nav-link">Rooms</a>
                <a href="/teacher_bookings" class="nav-link">All Bookings</a>
            </div>
            <div class="navbar-auth">
                <button id="logoutBtn" class="btn-nav btn-logout">Logout</button>
            </div>
        </nav>

        <main class="main-content">
            <div class="dashboard-section">
                <h2>Create New Room</h2>
                <form id="createRoomForm" class="form card">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="room_no">Room Number:</label>
                            <input type="text" id="room_no" name="room_no" required placeholder="e.g., 902 Lab">
                        </div>
                        <div class="form-group">
                            <label for="date">Date:</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="time_from">Time From:</label>
                            <input type="time" id="time_from" name="time_from" required>
                        </div>
                        <div class="form-group">
                            <label for="time_to">Time To:</label>
                            <input type="time" id="time_to" name="time_to" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Room & Generate Slots</button>
                </form>
                <div id="createMessage" class="message"></div>
            </div>

            <!-- Edit Room Modal -->
            <div id="editRoomModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Edit Room</h3>
                        <span class="modal-close" onclick="hideEditRoomModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="editRoomForm">
                            <input type="hidden" id="edit_room_id" name="room_id">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="edit_room_no">Room Number:</label>
                                    <input type="text" id="edit_room_no" name="room_no" required placeholder="e.g., 902 Lab">
                                </div>
                                <div class="form-group">
                                    <label for="edit_date">Date:</label>
                                    <input type="date" id="edit_date" name="date" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="edit_time_from">Time From:</label>
                                    <input type="time" id="edit_time_from" name="time_from" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit_time_to">Time To:</label>
                                    <input type="time" id="edit_time_to" name="time_to" required>
                                </div>
                            </div>
                            <div class="modal-actions">
                                <button type="button" class="btn btn-secondary" onclick="hideEditRoomModal()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Update Room</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="dashboard-section">
                <h2>Room Overview</h2>
                <div id="roomsContainer" class="rooms-container">
                    <p>Loading rooms...</p>
                </div>
            </div>

            <div class="dashboard-section">
                <h2>All Bookings</h2>
                <div id="bookingsContainer" class="bookings-container">
                    <p>Loading bookings...</p>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>&copy; 2025 Unislot-Presentation Room Booking System</p>
        </footer>
    </div>

    <script>
        // Set default date to today
        document.getElementById('date').valueAsDate = new Date();

        // Check authentication on page load
        window.addEventListener('load', async function() {
            try {
                const response = await fetch('/api/auth/check');
                if (!response.ok) {
                    window.location.href = '/login';
                    return;
                }

                const result = await response.json();
                if (result.role !== 'teacher') {
                    window.location.href = '/';
                    return;
                }

                // Check if modal elements exist
                console.log('Modal elements check:');
                console.log('editRoomModal:', document.getElementById('editRoomModal'));
                console.log('editRoomForm:', document.getElementById('editRoomForm'));
                console.log('edit_room_id:', document.getElementById('edit_room_id'));

                // Ensure modal is properly hidden initially
                const modal = document.getElementById('editRoomModal');
                if (modal) {
                    modal.classList.remove('show');
                    console.log('Modal show class removed');
                } else {
                    console.error('Modal element not found!');
                }

                // Test modal functionality
                console.log('Setting up modal test...');
                setTimeout(() => {
                    console.log('Modal test: editRoomModal exists:', !!document.getElementById('editRoomModal'));
                    console.log('Modal test: editRoomForm exists:', !!document.getElementById('editRoomForm'));
                }, 1000);

                // Load data
                loadRooms();
                loadAllBookings();
            } catch (error) {
                window.location.href = '/login';
            }
        });

        // Create room form submission
        document.getElementById('createRoomForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                room_no: formData.get('room_no'),
                date: formData.get('date'),
                time_from: formData.get('time_from'),
                time_to: formData.get('time_to')
            };

            try {
                const response = await fetch('/api/teacher/create-room', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(`Room created successfully! Generated ${result.slots_created} slots.`, 'success');
                    this.reset();
                    document.getElementById('date').valueAsDate = new Date();
                    
                    // Refresh data
                    loadRooms();
                    loadAllBookings();
                } else {
                    showMessage(result.error || 'Failed to create room', 'error');
                }
            } catch (error) {
                showMessage('Network error. Please try again.', 'error');
            }
        });

        // Load rooms overview
        async function loadRooms() {
            try {
                const response = await fetch('/api/teacher/rooms');
                const result = await response.json();
                
                const container = document.getElementById('roomsContainer');
                
                if (result.rooms.length === 0) {
                    container.innerHTML = '<p class="no-data">No rooms created yet.</p>';
                    return;
                }
                
                const roomsHTML = result.rooms.map(room => {
                    // Format date to DD-MM-YYYY
                    const dateParts = room.date_available.split('-');
                    const formattedDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0]}`;

                    // Format time to HH-MM AM/PM
                    const formatTime = (timeStr) => {
                        const [hours, minutes] = timeStr.split(':');
                        const hour24 = parseInt(hours);
                        const hour12 = hour24 === 0 ? 12 : hour24 > 12 ? hour24 - 12 : hour24;
                        const ampm = hour24 >= 12 ? 'PM' : 'AM';
                        return `${String(hour12).padStart(2, '0')}-${String(minutes).padStart(2, '0')} ${ampm}`;
                    };

                    const formattedStartTime = formatTime(room.time_from);
                    const formattedEndTime = formatTime(room.time_to);

                    console.log('Room data for edit:', {
                        room_id: room.room_id,
                        room_no: room.room_no,
                        date_available: room.date_available,
                        time_from: room.time_from,
                        time_to: room.time_to,
                        date_formatted: room.date_available,
                        time_from_formatted: room.time_from,
                        time_to_formatted: room.time_to
                    });

                    return `
                    <div class="booking-card card">
                        <div class="booking-info">
                            <h3>Room ${room.room_no} <span class="room-status">Active</span></h3>
                            <p><strong>Date:</strong> ${formattedDate}</p>
                            <p><strong>Time:</strong> ${formattedStartTime} - ${formattedEndTime}</p>
                            <p><strong>Available Slots:</strong> ${room.available_slots}/${room.total_slots}</p>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 6px;">
                            <button class="btn btn-secondary card-secondary" onclick="handleEditClick(${room.room_id}, '${room.room_no}', '${room.date_available}', '${room.time_from}', '${room.time_to}')" style="width: 100%;">
                                Edit Room
                            </button>
                            <button class="btn btn-danger" onclick="deleteRoom(${room.room_id})" style="width: 100%;">
                                Delete Room
                            </button>
                        </div>
                    </div>
                    `;
                }).join('');
                
                container.innerHTML = roomsHTML;
            } catch (error) {
                document.getElementById('roomsContainer').innerHTML = 
                    '<p class="error">Error loading rooms. Please refresh the page.</p>';
            }
        }

        // Load all bookings
        async function loadAllBookings() {
            try {
                const response = await fetch('/api/teacher/bookings');
                const result = await response.json();
                
                const container = document.getElementById('bookingsContainer');
                
                if (result.bookings.length === 0) {
                    container.innerHTML = '<p class="no-data">No bookings found.</p>';
                    return;
                }
                
                const bookingsHTML = result.bookings.map(booking => {
                    // Format date to DD-MM-YYYY
                    const dateParts = booking.date.split('-');
                    const formattedDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0]}`;

                    // Format time to HH-MM AM/PM
                    const formatTime = (timeStr) => {
                        const [hours, minutes] = timeStr.split(':');
                        const hour24 = parseInt(hours);
                        const hour12 = hour24 === 0 ? 12 : hour24 > 12 ? hour24 - 12 : hour24;
                        const ampm = hour24 >= 12 ? 'PM' : 'AM';
                        return `${String(hour12).padStart(2, '0')}-${String(minutes).padStart(2, '0')} ${ampm}`;
                    };

                    const formattedStartTime = formatTime(booking.time_start);
                    const formattedEndTime = formatTime(booking.time_end);

                    // Format booking time to DD-MM-YYYY HH-MM AM/PM
                    const bookingDate = new Date(booking.booking_time);
                    const bookingDay = String(bookingDate.getDate()).padStart(2, '0');
                    const bookingMonth = String(bookingDate.getMonth() + 1).padStart(2, '0');
                    const bookingYear = bookingDate.getFullYear();
                    const bookingHour24 = bookingDate.getHours();
                    const bookingHour12 = bookingHour24 === 0 ? 12 : bookingHour24 > 12 ? bookingHour24 - 12 : bookingHour24;
                    const bookingMinutes = String(bookingDate.getMinutes()).padStart(2, '0');
                    const bookingAmpm = bookingHour24 >= 12 ? 'PM' : 'AM';

                    const formattedBookingTime = `${bookingDay}-${bookingMonth}-${bookingYear} ${String(bookingHour12).padStart(2, '0')}-${bookingMinutes} ${bookingAmpm}`;

                    return `
                    <div class="booking-card card">
                        <div class="booking-info">
                            <h3>Room ${booking.room_no}</h3>
                            <p><strong>Student:</strong> ${booking.student_name} (${booking.student_id})</p>
                            <p><strong>Date:</strong> ${formattedDate}</p>
                            <p><strong>Time:</strong> ${formattedStartTime} - ${formattedEndTime}</p>
                            <p><strong>Token:</strong> <code>${booking.token_code}</code></p>
                            <p><strong>Booked:</strong> ${formattedBookingTime}</p>
                        </div>
                    </div>
                    `;
                }).join('');
                
                container.innerHTML = bookingsHTML;
            } catch (error) {
                document.getElementById('bookingsContainer').innerHTML = 
                    '<p class="error">Error loading bookings. Please refresh the page.</p>';
            }
        }

        // Show message
        function showMessage(text, type) {
            const messageDiv = document.getElementById('createMessage');
            messageDiv.textContent = text;
            messageDiv.className = `message message-${type}`;
            messageDiv.style.display = 'block';

            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // Show toast notification
        function showToast(text, type = 'info') {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());

            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-content">
                    <span class="toast-icon">${getToastIcon(type)}</span>
                    <span class="toast-text">${text}</span>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;

            // Add to page
            document.body.appendChild(toast);

            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);

            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Get toast icon based on type
        function getToastIcon(type) {
            switch(type) {
                case 'success': return '✓';
                case 'error': return '✕';
                case 'warning': return '⚠';
                case 'info': return 'ℹ';
                default: return 'ℹ';
            }
        }

        // Test modal function
        function testModal() {
            console.log('Testing modal...');
            document.getElementById('edit_room_id').value = '1';
            document.getElementById('edit_room_no').value = '56';
            document.getElementById('edit_date').value = '2025-01-31';
            document.getElementById('edit_time_from').value = '10:00';
            document.getElementById('edit_time_to').value = '17:00';
            document.getElementById('editRoomModal').style.display = 'block';
            console.log('Test modal opened');
        }

        // Handle edit button click
        function handleEditClick(roomId, roomNo, date, timeFrom, timeTo) {
            editRoom(roomId, roomNo, date, timeFrom, timeTo);
        }

        // Edit room
        function editRoom(roomId, roomNo, date, timeFrom, timeTo) {
            try {
                // Check if elements exist
                const modal = document.getElementById('editRoomModal');
                const roomIdField = document.getElementById('edit_room_id');
                const roomNoField = document.getElementById('edit_room_no');
                const dateField = document.getElementById('edit_date');
                const timeFromField = document.getElementById('edit_time_from');
                const timeToField = document.getElementById('edit_time_to');

                if (!modal || !roomIdField || !roomNoField || !dateField || !timeFromField || !timeToField) {
                    alert('Error: Modal elements not found!');
                    return;
                }

                // Populate form fields
                roomIdField.value = roomId;
                roomNoField.value = roomNo;
                dateField.value = date;
                timeFromField.value = timeFrom;
                timeToField.value = timeTo;

                // Show modal using CSS class
                modal.classList.add('show');
            } catch (error) {
                alert('Error opening edit modal: ' + error.message);
            }
        }

        // Hide edit room modal
        function hideEditRoomModal() {
            const modal = document.getElementById('editRoomModal');
            modal.classList.remove('show');
            document.getElementById('editRoomForm').reset();
        }

        // Handle edit room form submission
        document.getElementById('editRoomForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                const formData = new FormData(e.target);
                const roomData = Object.fromEntries(formData);
                const roomId = roomData.room_id;

                // Remove room_id from the data object as it's in the URL
                delete roomData.room_id;

                const response = await fetch(`/api/teacher/rooms/${roomId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(roomData)
                });

                if (!response.ok) {
                    alert('HTTP error: ' + response.status);
                    return;
                }

                const result = await response.json();

                if (result.success) {
                    showMessage('Room updated successfully!', 'success');
                    hideEditRoomModal();
                    // Refresh data
                    loadRooms();
                    loadAllBookings();
                } else {
                    // Handle specific error messages
                    if (result.error && result.error.includes('active bookings')) {
                        showToast(result.error, 'warning');
                    } else {
                        showMessage(result.error || 'Failed to update room', 'error');
                    }
                }
            } catch (error) {
                console.error('Network error:', error);
                alert('Network error: ' + error.message);
                showMessage('Network error. Please try again.', 'error');
            }
        });

        // Delete room
        async function deleteRoom(roomId) {
            if (!confirm('Are you sure you want to delete this room? This will also delete all its slots. This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/teacher/delete-room?room_id=${roomId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    alert('HTTP error: ' + response.status);
                    return;
                }

                const result = await response.json();

                if (result.success) {
                    showMessage('Room deleted successfully!', 'success');
                    // Refresh data
                    loadRooms();
                    loadAllBookings();
                } else {
                    showMessage(result.error || 'Failed to delete room', 'error');
                }
            } catch (error) {
                showMessage('Network error. Please try again.', 'error');
            }
        }

        // Delete slot
        async function deleteSlot(slotId) {
            console.log('Delete slot called with ID:', slotId);
            alert('Delete slot called with ID: ' + slotId);

            if (!confirm('Are you sure you want to delete this slot? This action cannot be undone.')) {
                return;
            }

            try {
                const url = `/api/teacher/delete-slot?slot_id=${slotId}`;
                console.log('Sending DELETE request to:', url);

                const response = await fetch(url, {
                    method: 'DELETE'
                });

                console.log('Delete slot response status:', response.status);

                if (!response.ok) {
                    console.error('HTTP error:', response.status);
                    alert('HTTP error: ' + response.status);
                    return;
                }

                const result = await response.json();
                console.log('Delete slot response data:', result);
                alert('Delete slot response: ' + JSON.stringify(result));

                if (result.success) {
                    showMessage('Slot deleted successfully!', 'success');
                    // Refresh data
                    loadRooms();
                    loadAllBookings();
                } else {
                    showMessage(result.error || 'Failed to delete slot', 'error');
                }
            } catch (error) {
                console.error('Network error in deleteSlot:', error);
                alert('Network error: ' + error.message);
                showMessage('Network error. Please try again.', 'error');
            }
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                window.location.href = '/';
            }
        });

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const editModal = document.getElementById('editRoomModal');
            if (event.target === editModal) {
                hideEditRoomModal();
            }
        });

        // Form validation for edit room form
        document.getElementById('editRoomForm').addEventListener('input', function(e) {
            const target = e.target;
            if (target.type === 'time') {
                // Validate time format
                const timeRegex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
                if (!timeRegex.test(target.value)) {
                    target.setCustomValidity('Please enter a valid time in HH:MM format');
                } else {
                    target.setCustomValidity('');
                }
            }
        });

        // Auto-close time picker after selection
        document.addEventListener('change', function(e) {
            if (e.target.type === 'time' || e.target.type === 'date') {
                // Blur the input to close the picker
                e.target.blur();
            }
        });

        // Additional handling for time picker close
        document.addEventListener('focusout', function(e) {
            if (e.target.type === 'time' || e.target.type === 'date') {
                // Small delay to ensure value is set before closing
                setTimeout(() => {
                    e.target.blur();
                }, 100);
            }
        });
    </script>
</body>
</html> 